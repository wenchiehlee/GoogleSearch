name: Quarantine Files (CSV-based)

on:
  workflow_run:
    workflows: ["Daily FactSet Search - Taiwan Financial Data"]  # Trigger after Search completes
    types:
      - completed

  workflow_dispatch:  # Allow manual trigger

jobs:
  quarantine-files:
    runs-on: ubuntu-latest
    # Only run if Search workflow succeeded (skip if failed)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyyaml python-dotenv

      - name: Count files before quarantine
        run: |
          echo "ğŸ“Š Files before quarantine:"
          ls -1 data/md/*.md 2>/dev/null | wc -l || echo "0"

      - name: Run quarantine script (CSV-based detection)
        run: |
          echo "ğŸ—‚ï¸ Starting CSV-based quarantine process..."
          echo "ğŸ“‹ Using: data/reports/factset_detailed_report_latest.csv"
          echo "ğŸ“Œ Criteria: quality_score >= 7.6"
          echo ""
          echo "yes" | python quarantine_files.py --quarantine

      - name: Count files after quarantine
        run: |
          echo "ğŸ“Š Files after quarantine:"
          ls -1 data/md/*.md 2>/dev/null | wc -l || echo "0"
          echo "ğŸ“ Quarantined files by reason:"
          du -sh data/quarantine/inflated_quality/ 2>/dev/null || echo "  inflated_quality: none"
          du -sh data/quarantine/inconsistent/ 2>/dev/null || echo "  inconsistent: none"
          du -sh data/quarantine/low_quality/ 2>/dev/null || echo "  low_quality: none"
          du -sh data/quarantine/old/ 2>/dev/null || echo "  old: none"

      - name: Check if there are changes
        id: check_changes
        run: |
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push quarantined files
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Stage quarantine directory and removed files from data/md
          git add data/quarantine/
          git add -u data/md/
          git add old_files_report.txt

          # Count quarantined files by reason
          INFLATED_COUNT=$(find data/quarantine/inflated_quality/ -name "*.md" 2>/dev/null | wc -l)
          TOTAL_QUARANTINED=$(git diff --cached --numstat | grep -c "data/quarantine" || echo "0")

          git commit \
            -m "chore: Daily quarantine - CSV-based detection" \
            -m "Quarantined files with inflated quality scores (score â‰¥7.6)" \
            -m "" \
            -m "Files quarantined: ${TOTAL_QUARANTINED}" \
            -m "  - Inflated quality: ${INFLATED_COUNT}" \
            -m "" \
            -m "Detection: CSV-based (data/reports/factset_detailed_report_latest.csv)" \
            -m "Criteria: quality_score >= 7.6" \
            -m "Schedule: Daily at 09:30 UTC (17:30 Taiwan)" \
            -m "Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" \
            -m "" \
            -m "ğŸ“‹ Report: old_files_report.txt" \
            -m "ğŸ“ Location: data/quarantine/inflated_quality/" \
            -m "" \
            -m "ğŸ¤– Generated by GitHub Actions - Daily Quarantine"

          git push

      - name: Create issue if many files quarantined (optional)
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the quarantine report
            let reportContent = 'No report available';
            try {
              reportContent = fs.readFileSync('old_files_report.txt', 'utf8');
            } catch (e) {
              console.log('Could not read report file');
            }

            // Extract key metrics from report
            const totalMatch = reportContent.match(/Total files to quarantine: (\d+)/);
            const totalFiles = totalMatch ? parseInt(totalMatch[1]) : 0;

            // Only create issue if more than 20 files were quarantined
            if (totalFiles > 20) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ—‚ï¸ Quarantine Alert: ${totalFiles} inflated quality files detected`,
                body: [
                  '## CSV-based Quarantine Report',
                  '',
                  'The automated quarantine process detected files with inflated quality scores.',
                  '',
                  '### Summary',
                  `- **Files quarantined**: ${totalFiles}`,
                  '- **Detection**: CSV-based (factset_detailed_report_latest.csv)',
                  '- **Criteria**: quality_score >= 7.6',
                  '- **Location**: `data/quarantine/inflated_quality/`',
                  `- **Date**: ${new Date().toISOString().split('T')[0]}`,
                  '',
                  '### What This Means',
                  'These files have high quality scores:',
                  '- May be general news articles, not FactSet reports',
                  '- Search queries may need refinement',
                  '- Consider reviewing search patterns',
                  '',
                  '### Next Steps',
                  '- Review quarantined files in `data/quarantine/inflated_quality/`',
                  '- Check if search queries need adjustment',
                  '- Monitor for recurring patterns',
                  '',
                  '### Full Report',
                  '```',
                  reportContent.substring(0, 5000),
                  '```',
                  '',
                  '---',
                  'ğŸ¤– Automatically generated after Process workflow',
                ].join('\n'),
                labels: ['data-quality', 'automated']
              });
            }

      - name: Summary
        run: |
          echo "âœ… CSV-based quarantine completed successfully!"
          echo "ğŸ“Š Detection method: CSV (quality_score >= 7.6)"
          echo "ğŸ“‹ Source: data/reports/factset_detailed_report_latest.csv (generated by Search workflow)"
          echo "ğŸ“ Check data/quarantine/inflated_quality/ for quarantined files"
          echo ""
          echo "Workflow order: Update Lists â†’ Search (+ CSV) â†’ Quarantine â†’ Process"
