# GoogleSearch
Working space for GoogleSearch

## Version Information
- **Current Version**: v2.0.3
- **Last Updated**: 2025-06-19
- **Author**: Generated by ChatGPT based on instructions
- **License**: MIT

## Version History
| Version | Date | Changes |
|---------|------|---------|
| v1.0.0 | Initial | Basic Google search with single query support |
| v1.1.0 | - | Added PDF download functionality |
| v1.2.0 | - | Added Markitdown conversion support |
| v2.0.0 | 2025-06-19 | Multi-query support, enhanced error handling, improved structure |
| v2.0.1 | 2025-06-19 | Added FactSet search with 觀察名單 filtering, enhanced file detection |
| v2.0.2 | 2025-06-19 | Fixed FactSet search to process all content types, not skip non-PDFs |
| v2.0.3 | 2025-06-19 | Added web page download and conversion to PDF/MD for FactSet matches |

## Overview
This project implements a Google Custom Search solution that searches for specific documents, downloads them, and converts them to Markdown format using the Markitdown project. Version 2.0.3 introduces web page download and conversion capabilities for FactSet searches, ensuring that all matched content (including news articles and web pages) is captured as both PDF and Markdown files.

## Features
- **Google Custom Search Integration**: Uses Google Custom Search JSON API to find documents
- **Intelligent Watch List Filtering**: Filters FactSet search results against 觀察名單 (watch list)
- **Web Page Download & Conversion**: Downloads web pages and converts them to both PDF and Markdown formats
- **Flexible Content Type Handling**: Processes PDFs and web pages appropriately based on search type
- **Automated PDF Download**: Downloads PDF files from search results to a designated folder
- **PDF to Markdown Conversion**: Converts downloaded PDFs to Markdown format using Microsoft's Markitdown tool
- **CSV Results Tracking**: Maintains comprehensive CSV files with search results and file paths
- **Multi-query Support**: Supports multiple search queries with different filtering strategies
- **Enhanced File Detection**: Improved content-type checking for accurate PDF identification

## Current Search Queries
1. **Financial Documents**: `"得標統計表 T004 -公司債 filetype:pdf"` - Searches for bond-related financial statistics documents
2. **FactSet Documents**: `"FactSet"` - Searches for FactSet-related content that matches 觀察名單
   - **Watch List Source**: https://raw.githubusercontent.com/wenchiehlee/GoPublic/refs/heads/main/%E8%A7%80%E5%AF%9F%E5%90%8D%E5%96%AE.csv
   - **Filtering Logic**: Results are filtered to include only items that mention companies/symbols from the watch list

## File Structure
```
GoogleSearch/
├── .github/
│   └── workflows/
│       └── Actions.yaml        # GitHub Actions workflow configuration
├── README.md                   # This documentation file
├── GoogleSearch.py             # Main search and processing script (v2.0.3)
├── requirements.txt            # Python dependencies list
├── .env                        # Environment variables (local development)
├── GoogleResults.csv           # Results for financial documents search
├── FactSetResults.csv          # Results for FactSet search (filtered by 觀察名單)
├── PDF/                        # Downloaded PDF files
└── MD/                         # Converted Markdown files
```

## GoogleSearch.py Script Details

### Script Information
- **File**: `GoogleSearch.py`
- **Current Version**: v2.0.3 (2025-06-19)
- **Architecture**: Object-oriented with modular functions
- **Version Control**: Built-in version tracking with `__version__`, `__date__`, and `__author__` variables

### Script Features
- **Version Display**: Shows version information on startup
- **Modular Design**: Separate functions for search, download, conversion, and filtering processes
- **Watch List Integration**: Downloads and parses 觀察名單 CSV for intelligent filtering
- **Web Page Processing**: Downloads and converts web pages to PDF and Markdown formats
- **Flexible Content Handling**: Configurable processing for PDF-only vs all content types
- **Error Handling**: Comprehensive error checking and graceful failure handling
- **Progress Tracking**: Real-time progress updates during batch processing
- **Multi-Query Support**: Handles multiple search queries with different filtering strategies
- **Enhanced File Detection**: Content-type validation for accurate PDF identification
- **Fallback Mechanisms**: Graceful degradation when optional tools unavailable

### Key Functions
- `google_search()`: Performs Google Custom Search API calls
- `download_watch_list()`: Downloads and parses 觀察名單 CSV from GitHub
- `filter_results_by_watch_list()`: Filters search results against watch list items
- `save_results_to_csv()`: Saves search results to CSV format
- `download_files_from_links_and_convert()`: Downloads files and converts PDFs to Markdown (supports pdf_only parameter)
- `download_web_page_as_pdf_and_md()`: Downloads web pages and converts them to both PDF and Markdown formats
- `process_search_query()`: Complete processing pipeline for a single query with optional filtering and content type control
- `is_markitdown_valid()`: Validates Markitdown tool availability
- `main()`: Main execution function with version display

## Requirements

### Prerequisites
1. **Google Custom Search API**:
   - Valid Google API key (`GOOGLE_SEARCH_API_KEY`)
   - Custom Search Engine ID (`GOOGLE_SEARCH_CSE_ID`)

2. **Markitdown Installation**:
   - Microsoft Markitdown tool must be installed and accessible in system PATH
   - Install via: `pip install markitdown`

3. **wkhtmltopdf Installation (Optional)**:
   - Required for web page to PDF conversion
   - Install on Ubuntu/Debian: `sudo apt-get install wkhtmltopdf`
   - Install on macOS: `brew install wkhtmltopdf`
   - Install on Windows: Download from https://wkhtmltopdf.org/downloads.html
   - Note: If not available, web pages will be saved as text files instead

4. **Python Dependencies**:
   - `requests`
   - `python-dotenv`
   - `csv` (built-in)
   - `os` (built-in)
   - `subprocess` (built-in)

5. **Dependencies File**:
   - `requirements.txt` containing all necessary Python packages
   - Install via: `pip install -r requirements.txt`

### Requirements.txt Contents
The `requirements.txt` file should contain:
```txt
requests>=2.31.0
python-dotenv>=1.0.0
markitdown>=0.0.1a2
```

**Optional System Dependencies**:
- `wkhtmltopdf` for web page to PDF conversion
- Install separately based on your operating system

### Environment Setup

#### Local Development
Create a `.env` file in the project root with:
```
GOOGLE_SEARCH_API_KEY=your_google_api_key_here
GOOGLE_SEARCH_CSE_ID=your_custom_search_engine_id_here
```

#### GitHub Actions (Automated Execution)
Set up the following repository secrets in GitHub:
- `GOOGLE_SEARCH_API_KEY`: Your Google API key
- `GOOGLE_SEARCH_CSE_ID`: Your Custom Search Engine ID

## GitHub Actions Automation

### Workflow Configuration
The project includes `.github/workflows/Actions.yaml` for automated execution via GitHub Actions:

**File Location**: `GoogleSearch/.github/workflows/Actions.yaml`

```yaml
name: Google Search On GitHub Action
on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "10 2 * * *"     # Runs every day at 2:10 AM UTC
```

### Automation Features
- **🔄 Automatic Triggers**:
  - Runs on every push to the `main` branch
  - Daily scheduled execution at 2:10 AM UTC
  - Manual trigger via GitHub workflow dispatch

- **🏗️ Environment Setup**:
  - Ubuntu latest runner
  - Python 3.10 installation
  - System dependencies: wkhtmltopdf for web page to PDF conversion
  - Automatic dependency installation from `requirements.txt`
  - Markitdown tool installation

- **🔐 Secure Credential Management**:
  - Uses GitHub repository secrets for API keys
  - No hardcoded credentials in the workflow

- **📋 Automated Workflow Steps**:
  1. **Repository Checkout**: Fetches latest code
  2. **Python Setup**: Configures Python 3.10 environment
  3. **Package Installation**: Installs all dependencies
  4. **Script Execution**: Runs GoogleSearch.py with environment variables
  5. **Results Commit**: Automatically commits and pushes generated files

- **📁 Automated File Management**:
  - Commits all CSV result files (`*.csv`)
  - Commits all downloaded PDF files (`PDF/*.pdf`)
  - Commits all downloaded text files (`PDF/*.txt`) - fallback for web pages
  - Commits all converted Markdown files (`MD/*.md`)
  - Uses `github-actions[bot]` for automated commits
  - Handles missing directories gracefully

### GitHub Actions Benefits
- **🕒 Scheduled Execution**: Daily automated searches ensure up-to-date results
- **🔄 Continuous Integration**: Automatically processes new searches on code changes
- **📊 Result Tracking**: All results are automatically committed to the repository
- **🚀 Zero-Maintenance**: Runs without manual intervention
- **📈 Audit Trail**: Complete history of automated executions in GitHub Actions logs

## Web Page Processing

### Overview
Version 2.0.3 introduces comprehensive web page download and conversion capabilities for FactSet searches. When a FactSet search result matches a company from the 觀察名單, the system now downloads the complete web page content and converts it to both PDF and Markdown formats.

### Processing Methods

#### Markdown Conversion
1. **Direct URL Processing**: Attempts to use Markitdown directly with the URL
2. **HTML Download Fallback**: Downloads HTML content and processes it through Markitdown
3. **Text Fallback**: If conversion fails, saves raw HTML content as structured text

#### PDF Conversion
1. **wkhtmltopdf**: Primary method using wkhtmltopdf tool for high-quality PDF generation
2. **Text Fallback**: If PDF conversion unavailable, creates a text file placeholder

### File Naming Convention
- **Web page PDFs**: `webpage1.pdf`, `webpage2.pdf`, etc.
- **Web page Markdown**: `webpage1.md`, `webpage2.md`, etc.
- **Text fallbacks**: `webpage1.txt`, `webpage2.txt`, etc.

### Supported Content Types
- **News articles** (like cnyes.com links)
- **Financial reports and analysis**
- **Company announcements**
- **Any web-based content mentioning 觀察名單 companies**

## Watch List Integration (觀察名單)

### Overview
Version 2.0.1 introduces intelligent filtering for FactSet searches using a dynamically downloaded watch list (觀察名單) from GitHub.

### Watch List Source
- **URL**: https://raw.githubusercontent.com/wenchiehlee/GoPublic/refs/heads/main/%E8%A7%80%E5%AF%9F%E5%90%8D%E5%96%AE.csv
- **Format**: CSV file containing company names and symbols
- **Update**: Downloaded fresh for each execution

### Filtering Process
1. **Download**: Watch list CSV is downloaded from GitHub repository
2. **Parse**: CSV content is parsed to extract company names/symbols
3. **Filter**: Search results are filtered to include only items mentioning watch list companies
4. **Match**: Matching occurs across title, snippet, and link content

### Filtering Logic
```python
# Example filtering process
for result in search_results:
    title = result.get('title', '').lower()
    snippet = result.get('snippet', '').lower()
    link = result.get('link', '').lower()
    
    for watch_item in watch_list:
        if watch_item.lower() in (title or snippet or link):
            filtered_results.append(result)
            break
```

## CSV Output Format
The generated CSV files contain the following columns:
- **Title**: Document title from search results
- **Link**: Direct link to the document (PDF or web page)
- **Snippet**: Brief description/snippet from search results
- **File**: Local file path of downloaded content (in PDF/ folder)
  - For PDFs: `.pdf` files
  - For web pages: `.pdf` files (if wkhtmltopdf available) or `.txt` files (fallback)
- **MD File**: Local file path of converted Markdown file (in MD/ folder)
  - Contains structured content converted from PDFs or web pages

**Note**: FactSet searches now download and convert ALL matched content, so both File and MD File columns will be populated for relevant results.

## Process Flow

### Financial Documents Search (得標統計表 T004)
1. **Search Execution**: Performs Google Custom Search for PDF documents
2. **Results Collection**: Gathers up to 500 search results with date restrictions
3. **CSV Generation**: Creates initial CSV file with search results metadata
4. **PDF Download**: Downloads PDF files from valid links to PDF/ folder
5. **Markdown Conversion**: Converts each PDF to Markdown using Markitdown tool
6. **CSV Update**: Updates CSV file with local file paths

### FactSet Documents Search
1. **Watch List Download**: Downloads 觀察名單 CSV from GitHub repository
2. **Search Execution**: Performs Google Custom Search for FactSet content (all types)
3. **Results Filtering**: Filters results against watch list companies/symbols
4. **CSV Generation**: Creates CSV file with filtered search results metadata
5. **Content Download & Conversion**: 
   - **PDF files**: Downloads and converts to Markdown using Markitdown
   - **Web pages**: Downloads HTML content and converts to both PDF (via wkhtmltopdf) and Markdown (via Markitdown)
   - **Fallback**: If PDF conversion fails, saves as text file
6. **CSV Update**: Updates CSV file with local file paths for all downloaded content

## Search Parameters
- **Maximum Results**: 500 per query
- **Date Restriction**: Last 360 days
- **Language Filter**: Traditional Chinese (lang_zh-TW)
- **Country Restriction**: Taiwan (countryTW)
- **Sort Order**: By date (most recent first)

## Enhanced Error Handling
- **Watch List Failures**: Graceful fallback when watch list cannot be downloaded
- **File Type Validation**: Content-type checking for accurate PDF identification
- **Content Type Flexibility**: Appropriate handling of both PDF and non-PDF content based on search type
- **Markitdown Availability**: Continues processing without conversion if Markitdown unavailable
- **HTTP Errors**: Comprehensive error handling during file downloads
- **PDF Conversion Failures**: Individual file failures don't stop batch processing
- **Progress Tracking**: Real-time status updates during batch processing

## Usage

### Manual Execution (Local Development)
Run the script directly on your local machine:
```bash
python GoogleSearch.py
```

### Automated Execution (GitHub Actions)
The script runs automatically via GitHub Actions in the following scenarios:

1. **📅 Daily Schedule**: Every day at 2:10 AM UTC
2. **🔄 Code Push**: Automatically when changes are pushed to the `main` branch  
3. **▶️ Manual Trigger**: Use GitHub's "Run workflow" button in the Actions tab

### Expected Output
```
GoogleSearch.py v2.0.3 - Multi-Query PDF Search and Conversion Tool
Date: 2025-06-19 | Author: Generated by ChatGPT
================================================================================

============================================================
Starting Financial Documents Search (得標統計表 T004)
Query: 得標統計表 T004 -公司債 filetype:pdf
Output file: GoogleResults.csv
Content type: PDF only
============================================================
Found X results for Financial Documents Search (得標統計表 T004)
Saved search results to GoogleResults.csv
Total rows to process for GoogleResults.csv: X
...

============================================================
Starting FactSet Documents Search
Query: FactSet
Output file: FactSetResults.csv
Watch list filtering: ENABLED
Content type: ALL (PDFs and web pages)
============================================================
Downloading 觀察名單 (watch list)...
Successfully loaded Y items from watch list
Found Z initial results for FactSet Documents Search
After watch list filtering: W results remain
Saved search results to FactSetResults.csv
Total rows to process for FactSetResults.csv: W
Processing web page: https://m.cnyes.com/news/id/5980270
Converting web page to Markdown using markitdown: https://m.cnyes.com/news/id/5980270
Successfully converted web page to Markdown: MD/webpage1.md
Converting web page to PDF: https://m.cnyes.com/news/id/5980270
Successfully converted web page to PDF: PDF/webpage1.pdf
...

============================================================
All search queries completed!
Generated files:
- GoogleResults.csv
- FactSetResults.csv
- PDF/ (downloaded PDF files and web pages)
- MD/ (converted Markdown files)
============================================================
GoogleSearch.py v2.0.3 - Process completed successfully!
```

The script will automatically:
1. Execute both search queries (financial documents and FactSet with filtering)
2. Download all found PDF files
3. Convert them to Markdown format
4. Generate/update the respective CSV files

## Version Control Guidelines

### Updating Version Information
When modifying `GoogleSearch.py`, update the following variables at the top of the script:
```python
__version__ = "X.Y.Z"  # Semantic versioning
__date__ = "YYYY-MM-DD"  # Last modification date
__author__ = "Author Name"  # Script author/modifier
```

### Version Numbering Convention
- **Major (X.0.0)**: Breaking changes, major feature additions, architecture changes
- **Minor (X.Y.0)**: New features, significant enhancements, backward compatible
- **Patch (X.Y.Z)**: Bug fixes, minor improvements, documentation updates

### Change Documentation
1. Update the version history table in README.md
2. Update the docstring version history in GoogleSearch.py
3. Update the `__version__`, `__date__`, and `__author__` variables
4. Document changes in commit messages

## GitHub Actions Monitoring

### Workflow Status
- **📊 Actions Tab**: Monitor workflow executions in the GitHub repository's Actions tab
- **✅ Success Indicators**: Green checkmarks indicate successful executions
- **❌ Failure Alerts**: Red X marks indicate failed executions with detailed logs
- **📈 Execution History**: Complete history of all automated runs

### Troubleshooting Common Issues

#### API Quota Exceeded
- **Symptom**: HTTP 403 errors in workflow logs
- **Solution**: Check Google API quota limits and upgrade if necessary
- **Monitoring**: Review daily API usage in Google Cloud Console

#### Watch List Download Failures
- **Symptom**: "Failed to download watch list" messages
- **Solution**: Check GitHub repository accessibility and CSV file availability
- **Fallback**: Script continues without filtering if watch list unavailable

#### wkhtmltopdf Installation Issues
- **Symptom**: "PDF conversion failed" messages for web pages
- **Solution**: Install wkhtmltopdf system package
- **Ubuntu/Debian**: `sudo apt-get install wkhtmltopdf`
- **macOS**: `brew install wkhtmltopdf`
- **Fallback**: Script continues with text file creation if PDF conversion unavailable

#### Markitdown Installation Failures  
- **Symptom**: "markitdown command not found" errors
- **Solution**: Verify `requirements.txt` includes all necessary dependencies
- **Check**: Ensure `pip install markitdown` step completes successfully

#### Repository Secrets Configuration
- **Required Secrets**:
  - `GOOGLE_SEARCH_API_KEY`
  - `GOOGLE_SEARCH_CSE_ID`
- **Setup Location**: Repository Settings → Secrets and variables → Actions

#### File Commit Issues
- **Symptom**: No new files appear after workflow execution
- **Check**: Verify workflow has write permissions to the repository
- **Solution**: Ensure `contents: write` permission is set in Actions.yaml if needed

### Workflow Customization
To modify the automation schedule, edit the cron expression in `.github/workflows/Actions.yaml`:
```yaml
schedule:
  - cron: "10 2 * * *"  # Current: Daily at 2:10 AM UTC
  # Examples:
  # - cron: "0 */6 * * *"    # Every 6 hours
  # - cron: "0 9 * * 1"     # Every Monday at 9 AM UTC
  # - cron: "30 1 1 * *"    # First day of each month at 1:30 AM UTC
```

### GitHub Actions Setup Instructions

1. **Create Workflow Directory**:
   ```bash
   mkdir -p .github/workflows
   ```

2. **Place Actions.yaml**: 
   - Copy `Actions.yaml` to `.github/workflows/Actions.yaml`
   - Ensure proper YAML formatting and indentation

3. **Configure Repository Secrets**:
   - Go to Repository Settings → Secrets and variables → Actions
   - Add `GOOGLE_SEARCH_API_KEY` and `GOOGLE_SEARCH_CSE_ID`

4. **Test Workflow**:
   - Push to main branch or use manual trigger
   - Monitor execution in the Actions tab

## Output Files
- `GoogleResults.csv`: Results and file paths for financial documents search
- `FactSetResults.csv`: Results and file paths for FactSet search (filtered by 觀察名單) with downloaded web content
- `PDF/`: Directory containing all downloaded PDF files and converted web pages (PDF or TXT format)
- `MD/`: Directory containing all converted Markdown files from PDFs and web pages

## Complete Project Files

### Core Files
- **`GoogleSearch.py`** (v2.0.3): Main search and processing script with watch list integration and web page download capabilities
- **`README.md`**: Comprehensive project documentation
- **`.github/workflows/Actions.yaml`**: GitHub Actions workflow configuration
- **`requirements.txt`**: Python dependencies specification
- **`.env`**: Environment variables (local development only, not committed)

### Generated Files (Auto-created)
- **`GoogleResults.csv`**: Financial documents search results and file paths
- **`FactSetResults.csv`**: FactSet documents search results and file paths (filtered by 觀察名單) with web content
- **`PDF/`**: Directory with downloaded PDF files and converted web pages
- **`MD/`**: Directory with converted Markdown files from all content types

### External Dependencies
- **觀察名單 CSV**: Dynamically downloaded from GitHub repository during FactSet search execution
- **Google Custom Search API**: External service for search functionality
- **Markitdown Tool**: External tool for PDF to Markdown conversion

### GitHub Integration
- **GitHub Secrets**: Secure storage for API credentials
- **GitHub Actions Logs**: Execution history and debugging information
- **Automated Commits**: Bot-generated commits with search results
- **Watch List Repository**: External GitHub repository for 觀察名單 CSV file